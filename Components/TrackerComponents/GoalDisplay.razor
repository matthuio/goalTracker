@using GoalTrackerServices
@rendermode InteractiveServer
@inject GoalServices GoalService

@if(Goals != null)
{
     @foreach(var goal in Goals)
     {
        <div class="goal-item">
            <p>@goal.Title</p>
            <button @onclick="(e)=>HandleClick(goal)">Delete</button>
            <button @onclick="(e)=>OpenModal(e,goal)">View</button>
        </div>
     }
}
@if(isOpen && goalToSend != null)
{
    <div class="modal-wrapper">
        <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Goal</h3>
            <button class="close-btn" @onclick="(e)=>OpenModal(e,goalToSend)">âœ•</button>
        </div>

        <div class="modal-section">
            <label>Goal Details</label>
            <input @bind="goalToSend.Title" placeholder="Goal Title"/>
            <input @bind="goalToSend.Desc" placeholder="Description"/>
            <input @bind="goalToSend.CompleteCondition" placeholder="Completion Condition" />
            <input @bind="goalToSend.Progress" placeholder="Progress"/>
        </div>

        @if(goalToSend?.Steps?.Any() == true)
        {
            <div class="modal-section">
                <label>Associated Goals</label>
                <div class="associated-goals">
                    @foreach(var goal in goalToSend.Steps)
                    {
                        <div class="associated-goal-item">
                            <span class="goal-name">@goal.Title</span>
                            <span class="goal-progress">@goal.Progress%</span>
                        </div>
                    }
                </div>
            </div>
        }

        <div class="modal-section">
            <label>Add Associated Goal</label>
            <div class="add-goal-section">
                <select @bind="SelectedGoal">
                    @if(Goals.Count() > 0)
                    {
                        @foreach(var goal in Goals)
                        {
                            <option value="@goal.Id">@goal.Title</option>
                        }
                    }
                </select>
                <button class="add-btn" @onclick="(e)=>HandleAdd(SelectedGoal)">Add</button>
            </div>
            
            @if(StepsList.Count()> 0)
            {
                <div class="pending-goals">
                    <small>Pending to add:</small>
                    @foreach(var goal in StepsList)
                    {
                        <div class="pending-goal-item">@goal.Title</div>
                    }
                </div>
            }
        </div>

        <div class="modal-actions">
            <button class="complete-btn" @onclick="(e)=>HandleSubmit(goalToSend)">Save Changes</button>
        </div>
        </div>
    </div>
}

@code {
    private int SelectedGoal = new();
    private List<Goal> StepsList = new();
    private Goal goalToSend {get;set;} = null;
    private bool isOpen {set;get;} = false;
    [Parameter]
    public List<Goal> ?Goals{get;set;}
    [Parameter]
    public EventCallback<Goal> OnClick{get;set;}
    private async Task HandleClick(Goal goal){
        await OnClick.InvokeAsync(goal);
    }
    private void OpenModal(MouseEventArgs e,Goal goal)
    {
        goalToSend = goal;
        isOpen = !isOpen;

    }
    [Parameter]
    public EventCallback<Goal> OnSubmit {get;set;}
    private async Task HandleSubmit(Goal goal)
    {
        if(StepsList.Any() == true)
        {
            goal.Steps = StepsList;
        }
        await OnSubmit.InvokeAsync(goal);
    }
    private async void HandleAdd(int goalId)
    {
       var goal =await GoalService.FindGoalId(goalId);
       if (goal != null)
       {
        StepsList.Add(goal);
       }
    }
}
